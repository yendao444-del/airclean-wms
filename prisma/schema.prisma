// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ========================================
// PRODUCTS & CATEGORIES
// ========================================

model Category {
  id          Int       @id @default(autoincrement())
  name        String
  description String?
  parentId    Int?
  parent      Category? @relation("CategoryToCategory", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryToCategory")
  products    Product[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Product {
  id          Int      @id @default(autoincrement())
  sku         String   @unique
  barcode     String?
  name        String
  description String?
  categoryId  Int?
  category    Category? @relation(fields: [categoryId], references: [id])
  
  // Pricing
  price       Float    // Giá bán
  cost        Float    // Giá vốn
  
  // Inventory
  stock       Int      @default(0)
  minStock    Int      @default(0)
  maxStock    Int?
  
  // Additional info
  unit        String   @default("Cái") // Cái, Hộp, Bộ, Kg, etc.
  weight      Float?
  images      String?  // JSON array of image URLs
  variants    String?  // JSON for variants (size, color, etc.)
  
  // Combo Products (Sapo-style)
  isCombo     Boolean  @default(false)
  comboItems  String?  // JSON: [{"sku": "1-5D-UNI-TRANG", "quantity": 10}]
  
  status      String   @default("active") // active, inactive
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  orderItems     OrderItem[]
  purchaseItems  PurchaseItem[]
  inventoryLogs  InventoryLog[]
}

// ========================================
// COMBO PRODUCTS (MIX)
// ========================================

model ComboProduct {
  id          Int      @id @default(autoincrement())
  sku         String   @unique
  barcode     String?
  name        String   // VD: "COMBO MIX 10 GÓI"
  description String?
  
  // Component Items - JSON array
  // [
  //   {productId: 1, variantIndex: 0, sku: "1-5DUNICARE-TRANG", quantity: 5},
  //   {productId: 1, variantIndex: 1, sku: "1-5DUNICARE-DEN", quantity: 5}
  // ]
  items       String   // JSON array of component items
  
  // Pricing
  price       Float    // Giá bán combo
  cost        Float    // Tổng giá vốn (auto-calculated)
  
  // Stock - KHÔNG LƯU, auto-calculate từ components
  // stock = MIN(component.stock / component.quantity)
  
  // Additional info
  unit        String   @default("Bộ")
  images      String?  // JSON array
  
  status      String   @default("active") // active, inactive
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([status])
  @@index([sku])
}

// ========================================
// INVENTORY MANAGEMENT
// ========================================

model InventoryLog {
  id         Int      @id @default(autoincrement())
  productId  Int
  product    Product  @relation(fields: [productId], references: [id])
  
  type       String   // purchase, sale, adjustment, return
  quantity   Int      // Positive for in, negative for out
  oldStock   Int
  newStock   Int
  reference  String?  // Reference to order/purchase order ID
  note       String?
  
  createdAt  DateTime @default(now())
  createdBy  Int?
  user       User?    @relation(fields: [createdBy], references: [id])
}

// ========================================
// SUPPLIERS & PURCHASES
// ========================================

model Supplier {
  id            Int             @id @default(autoincrement())
  code          String          @unique
  name          String
  phone         String?
  email         String?
  address       String?
  taxCode       String?
  debt          Float           @default(0)
  
  status        String          @default("active")
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  
  purchaseOrders PurchaseOrder[]
}

model PurchaseOrder {
  id         Int      @id @default(autoincrement())
  poNumber   String   @unique
  supplierId Int
  supplier   Supplier @relation(fields: [supplierId], references: [id])
  
  status     String   @default("pending") // pending, received, cancelled
  
  subtotal   Float    @default(0)
  discount   Float    @default(0)
  tax        Float    @default(0)
  total      Float
  paidAmount Float    @default(0)
  
  note       String?
  receivedAt DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  createdBy  String?  // Username của người tạo
  
  items      PurchaseItem[]
}

model PurchaseItem {
  id              Int           @id @default(autoincrement())
  purchaseOrderId Int
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  productId       Int
  product         Product       @relation(fields: [productId], references: [id])
  
  quantity        Int
  price           Float  // Giá nhập
  subtotal        Float
  
  // Thông tin phân loại (variant)
  variantSku      String?  // SKU của variant nếu có
  color           String?  // Màu sắc nếu có
  
  createdAt       DateTime @default(now())
}

// ========================================
// CUSTOMERS
// ========================================

model Customer {
  id           Int      @id @default(autoincrement())
  code         String   @unique
  name         String
  phone        String?
  email        String?
  address      String?
  
  loyaltyPoints Int     @default(0)
  totalSpent   Float    @default(0)
  totalOrders  Int      @default(0)
  debt         Float    @default(0)
  
  tags         String?  // JSON array
  notes        String?
  
  status       String   @default("active")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  orders       Order[]
}

// ========================================
// ORDERS & SALES
// ========================================

model Order {
  id            Int      @id @default(autoincrement())
  orderNumber   String   @unique
  customerId    Int?
  customer      Customer? @relation(fields: [customerId], references: [id])
  
  source        String   @default("pos") // pos, shopee, tiktok, web
  status        String   @default("pending") // pending, processing, shipping, completed, cancelled
  paymentStatus String   @default("unpaid") // unpaid, partial, paid
  paymentMethod String?  // cash, bank_transfer, card, momo, etc.
  
  // Amounts
  subtotal      Float
  discount      Float    @default(0)
  tax           Float    @default(0)
  shippingFee   Float    @default(0)
  total         Float
  profit        Float    @default(0)
  
  trackingNumber String?
  note          String?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  createdBy     Int?
  user          User?    @relation(fields: [createdBy], references: [id])
  
  items         OrderItem[]
  payments      Payment[]
}

model OrderItem {
  id          Int     @id @default(autoincrement())
  orderId     Int
  order       Order   @relation(fields: [orderId], references: [id])
  productId   Int
  product     Product @relation(fields: [productId], references: [id])
  
  sku         String
  productName String
  variant     String? // JSON for selected variant
  
  quantity    Int
  price       Float   // Giá bán
  cost        Float   // Giá vốn
  discount    Float   @default(0)
  subtotal    Float
  
  createdAt   DateTime @default(now())
}

model Payment {
  id            Int      @id @default(autoincrement())
  orderId       Int
  order         Order    @relation(fields: [orderId], references: [id])
  
  method        String   // cash, bank_transfer, card, etc.
  amount        Float
  transactionId String?
  note          String?
  
  createdAt     DateTime @default(now())
  createdBy     Int?
  user          User?    @relation(fields: [createdBy], references: [id])
}

// ========================================
// USERS & PERMISSIONS
// ========================================

model User {
  id          Int      @id @default(autoincrement())
  username    String   @unique
  password    String   // Hashed with bcrypt
  fullName    String
  email       String?
  phone       String?
  
  role        String   @default("staff") // admin, manager, staff
  permissions String?  // JSON array of permissions
  status      String   @default("active") // active, inactive
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  orders         Order[]
  payments       Payment[]
  inventoryLogs  InventoryLog[]
  expenses       Expense[]
}

// ========================================
// EXPENSES
// ========================================

model Expense {
  id          Int      @id @default(autoincrement())
  category    String   // rent, utilities, salary, etc.
  description String
  amount      Float
  date        DateTime
  
  createdAt   DateTime @default(now())
  createdBy   Int?
  user        User?    @relation(fields: [createdBy], references: [id])
}

// ========================================
// ECOMMERCE EXPORTS / XUẤT HÀNG TMDT
// ========================================

model EcommerceExport {
  id                    Int      @id @default(autoincrement())
  customerName          String   // Shopee, TikTok, etc.
  ecommerceExportCode   String?  // Mã phiếu xuất
  orderNumber           String?  // Mã đơn hàng / Mã vận đơn
  ecommerceExportReason String?  // Lý do xuất
  ecommerceExportDate   DateTime // Ngày xuất
  items                 String   // JSON array of items
  totalAmount           Float    @default(0)
  notes                 String?
  status                String   @default("processing") // processing, completed
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  createdBy             String?

  @@index([status])
  @@index([customerName])
  @@index([ecommerceExportDate])
}

// ========================================
// EXPORT ORDERS / XUẤT HÀNG POS
// ========================================

model ExportOrder {
  id          Int      @id @default(autoincrement())
  exportDate  DateTime // Ngày xuất
  customer    String   // Tên khách hàng
  status      String   @default("processing") // processing, completed
  totalAmount Float    @default(0)
  notes       String?
  items       String   // JSON array of ExportItem
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?

  @@index([status])
  @@index([exportDate])
}

// ========================================
// RETURNS / TRẢ HÀNG
// ========================================

model Return {
  id            Int      @id @default(autoincrement())
  customerName  String   // Tên khách hàng
  returnCode    String?  // Mã phiếu trả
  orderNumber   String?  // Mã đơn hàng gốc
  returnReason  String?  // Lý do trả
  returnDate    DateTime // Ngày trả
  items         String   // JSON array of items
  totalAmount   Float    @default(0)
  notes         String?
  status        String   @default("pending") // pending, approved, completed, rejected
  packer        String?  // Người đóng gói
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  createdBy     String?

  @@index([status])
  @@index([returnDate])
  @@index([customerName])
}

// ========================================
// REFUNDS / HÀNG HOÀN
// ========================================

model Refund {
  id            Int      @id @default(autoincrement())
  customerName  String   // Tên khách hàng / Sàn
  refundCode    String?  // Mã phiếu hoàn
  orderNumber   String?  // Mã đơn hàng / Mã vận đơn
  refundReason  String?  // Lý do hoàn
  refundDate    DateTime // Ngày hoàn
  items         String   // JSON array of items
  totalAmount   Float    @default(0)
  notes         String?
  status        String   @default("processing") // processing, completed
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  createdBy     String?

  @@index([status])
  @@index([refundDate])
  @@index([orderNumber])
}

// ========================================
// STOCK BALANCE / CÂN BẰNG KHO
// ========================================

model StockBalance {
  id          Int      @id @default(autoincrement())
  date        DateTime // Ngày cân bằng
  adjustedBy  String   // Người thực hiện
  items       String   // JSON array of StockBalanceItem
  notes       String?
  createdAt   DateTime @default(now())

  @@index([date])
}

// ========================================
// APP CONFIG / CẤU HÌNH ỨNG DỤNG
// ========================================

model AppConfig {
  id    Int    @id @default(autoincrement())
  key   String @unique // e.g. 'packerList', 'statusList', 'assigneeList', 'feesConfig', 'configVersion'
  value String // JSON value
  
  updatedAt DateTime @updatedAt
}

// ========================================
// DAILY TASKS / CÔNG VIỆC HÀNG NGÀY
// ========================================

model DailyTask {
  id            Int      @id @default(autoincrement())
  title         String   // Tên công việc
  description   String?  // Mô tả chi tiết
  
  // Phân công
  assignee      String   // Người phụ trách (Khánh, Toàn, Phượng...)
  verifier      String?  // Người xác nhận
  area          String?  // Khu vực (Shopee/Tiktok, Kho, Văn phòng...)
  
  // Thời gian
  dueDate       DateTime // Thời hạn hoàn thành
  completedAt   DateTime? // Thời điểm hoàn thành
  
  // Trạng thái & Ưu tiên
  status        String   @default("pending") // pending, in_progress, completed, cancelled, overdue
  priority      String   @default("normal")  // low, normal, high, urgent
  
  // Danh mục công việc
  category      String   @default("general") // general, checkin, inventory, customer_service, cleaning, report, etc.
  
  // Metadata
  tags          String?  // JSON array: ["CTKM", "THI", "Urgent"]
  attachments   String?  // JSON array of file paths/URLs
  note          String?  // Ghi chú
  
  // Tracking
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  createdBy     String   @default("System")
  
  @@index([status, dueDate])
  @@index([assignee, status])
  @@index([dueDate])
}

// ========================================
// ACTIVITY LOGS / HISTORY
// ========================================

model ActivityLog {
  id          Int      @id @default(autoincrement())
  
  // Phân loại
  module      String   // 'products', 'returns', 'sales', 'purchases', 'customers'
  action      String   // 'CREATE', 'UPDATE', 'DELETE'
  
  // Liên kết
  recordId    Int?     // ID của record bị thay đổi
  recordName  String?  // Tên hiển thị (VD: "Khẩu trang UV", "Đơn #123")
  
  // Thay đổi
  changes     String?  // JSON diff {field: {old: x, new: y}}
  description String   // Mô tả ngắn gọn: "Cập nhật giá từ 100,000đ → 120,000đ"
  
  // Metadata
  userName    String   @default("Admin")
  userId      Int?
  timestamp   DateTime @default(now())
  
  // Extra
  severity    String   @default("INFO") // 'INFO', 'WARNING', 'CRITICAL'
  ipAddress   String?
  deviceInfo  String?
  
  @@index([module, timestamp])
  @@index([module, recordId])
  @@index([userId, timestamp])
}
